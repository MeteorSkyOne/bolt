# Interactive Database - Client-Server Makefile

.PHONY: all build clean server client help test demo multi-test transaction-test

# é»˜è®¤é…ç½®
DEFAULT_PORT=8080
DEFAULT_DB=interactive.db

# é»˜è®¤ç›®æ ‡
all: build

# ç¼–è¯‘æ‰€æœ‰ç¨‹åº
build:
	@echo "Building server and client..."
	go build -o bin/server ./cmd/server
	go build -o bin/client ./cmd/client
	@echo "Build complete. Binaries are in bin/ directory."

# ç¼–è¯‘æœåŠ¡å™¨
server-build:
	@echo "Building server..."
	go build -o bin/server ./cmd/server

# ç¼–è¯‘å®¢æˆ·ç«¯
client-build:
	@echo "Building client..."
	go build -o bin/client ./cmd/client

# è¿è¡ŒæœåŠ¡å™¨ï¼ˆé»˜è®¤é…ç½®ï¼‰
server:
	@echo "Starting database server on port $(DEFAULT_PORT) with database $(DEFAULT_DB)..."
	go run ./cmd/server --port $(DEFAULT_PORT) --db $(DEFAULT_DB)

# è¿è¡ŒæœåŠ¡å™¨ï¼ˆè‡ªå®šä¹‰ç«¯å£ï¼‰
server-port:
	@if [ -z "$(PORT)" ]; then \
		echo "Usage: make server-port PORT=8081"; \
		exit 1; \
	fi
	@echo "Starting database server on port $(PORT) with database $(DEFAULT_DB)..."
	go run ./cmd/server --port $(PORT) --db $(DEFAULT_DB)

# è¿è¡ŒæœåŠ¡å™¨ï¼ˆè‡ªå®šä¹‰æ•°æ®åº“æ–‡ä»¶ï¼‰
server-db:
	@if [ -z "$(DB)" ]; then \
		echo "Usage: make server-db DB=mydata.db"; \
		exit 1; \
	fi
	@echo "Starting database server on port $(DEFAULT_PORT) with database $(DB)..."
	go run ./cmd/server --port $(DEFAULT_PORT) --db $(DB)

# è¿è¡ŒæœåŠ¡å™¨ï¼ˆè‡ªå®šä¹‰ç«¯å£å’Œæ•°æ®åº“æ–‡ä»¶ï¼‰
server-custom:
	@if [ -z "$(PORT)" ] || [ -z "$(DB)" ]; then \
		echo "Usage: make server-custom PORT=8081 DB=mydata.db"; \
		exit 1; \
	fi
	@echo "Starting database server on port $(PORT) with database $(DB)..."
	go run ./cmd/server --port $(PORT) --db $(DB)

# è¿è¡Œå®¢æˆ·ç«¯ï¼ˆäº¤äº’å¼ï¼Œé»˜è®¤ç«¯å£ï¼‰
client:
	@echo "Starting interactive client..."
	go run ./cmd/client

# è¿è¡Œå®¢æˆ·ç«¯ï¼ˆè‡ªå®šä¹‰ç«¯å£ï¼‰
client-port:
	@if [ -z "$(PORT)" ]; then \
		echo "Usage: make client-port PORT=8081"; \
		exit 1; \
	fi
	@echo "Starting interactive client connecting to port $(PORT)..."
	go run ./cmd/client --port $(PORT)

# è¿è¡ŒåŸºç¡€æµ‹è¯•
test:
	@echo "Running basic functionality test..."
	go run ./cmd/client --batch tests/basic/test_sample.txt

# è¿è¡Œå¤šå®ä¾‹æµ‹è¯•
multi-test:
	@echo "Running multi-instance test..."
	chmod +x tests/concurrent/multi_instance_test.sh
	./tests/concurrent/multi_instance_test.sh

# è¿è¡Œå¤šè¿›ç¨‹äº‹åŠ¡æ­£ç¡®æ€§æµ‹è¯•
transaction-test:
	@echo "Running multi-process transaction correctness test..."
	chmod +x tests/concurrent/multi_process_transaction_test.sh
	./tests/concurrent/multi_process_transaction_test.sh

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
test-all: test multi-test transaction-test
	@echo "All tests completed!"

# æ¼”ç¤ºå¤šå®¢æˆ·ç«¯åŠŸèƒ½ï¼ˆéœ€è¦åœ¨ä¸åŒç»ˆç«¯ä¸­è¿è¡Œï¼‰
demo:
	@echo "To demo multi-client functionality:"
	@echo "1. Terminal 1: make server"
	@echo "2. Terminal 2: make client"
	@echo "3. Terminal 3: make client"
	@echo "4. Terminal 4: make test"

# æ¸…ç†ç¼–è¯‘æ–‡ä»¶å’Œæ•°æ®åº“
clean:
	@echo "Cleaning up..."
	rm -rf bin/
	rm -f interactive.db
	rm -rf test_output/
	rm -rf test_results/
	@echo "Clean complete."

# åˆ›å»ºç›®å½•
bin:
	mkdir -p bin

# å®Œæ•´æµ‹è¯•æµç¨‹ï¼ˆè¿è¡Œæ‰€æœ‰æµ‹è¯•å¥—ä»¶ï¼‰
full-test: build
	@echo "=========================================="
	@echo "Interactive Database - å®Œæ•´æµ‹è¯•å¥—ä»¶"
	@echo "=========================================="
	@echo ""
	@echo "å¼€å§‹è¿è¡Œæ‰€æœ‰æµ‹è¯•..."
	@echo ""
	@echo "æµ‹è¯•1: åŸºç¡€åŠŸèƒ½æµ‹è¯•"
	@echo "==================="
	@if pkill -f "bin/server" >/dev/null 2>&1; then echo "åœæ­¢ç°æœ‰æœåŠ¡å™¨..."; fi
	@sleep 1
	@./bin/server --port 8080 --db test_full.db & echo $$! > .server_pid
	@sleep 3
	@if ./bin/client --batch tests/basic/test_sample.txt > test_basic_result.log 2>&1; then \
		echo "âœ… åŸºç¡€åŠŸèƒ½æµ‹è¯• - PASS"; \
		TEST1_RESULT="PASS"; \
	else \
		echo "âŒ åŸºç¡€åŠŸèƒ½æµ‹è¯• - FAIL"; \
		TEST1_RESULT="FAIL"; \
	fi
	@if [ -f .server_pid ]; then kill `cat .server_pid` 2>/dev/null || true; rm -f .server_pid; fi
	@sleep 2
	@echo ""
	@echo "æµ‹è¯•2: å¤šå®ä¾‹å¹¶å‘æµ‹è¯•"
	@echo "==================="
	@if ./tests/concurrent/multi_instance_test.sh > test_multi_result.log 2>&1; then \
		echo "âœ… å¤šå®ä¾‹å¹¶å‘æµ‹è¯• - PASS"; \
		TEST2_RESULT="PASS"; \
	else \
		echo "âŒ å¤šå®ä¾‹å¹¶å‘æµ‹è¯• - FAIL"; \
		TEST2_RESULT="FAIL"; \
	fi
	@echo ""
	@echo "æµ‹è¯•3: äº‹åŠ¡æ­£ç¡®æ€§æµ‹è¯•"
	@echo "==================="
	@if ./tests/concurrent/multi_process_transaction_test.sh > test_transaction_result.log 2>&1; then \
		echo "âœ… äº‹åŠ¡æ­£ç¡®æ€§æµ‹è¯• - PASS"; \
		TEST3_RESULT="PASS"; \
	else \
		echo "âŒ äº‹åŠ¡æ­£ç¡®æ€§æµ‹è¯• - FAIL"; \
		TEST3_RESULT="FAIL"; \
	fi
	@echo ""
	@echo "=========================================="
	@echo "æµ‹è¯•ç»“æœæ€»ç»“"
	@echo "=========================================="
	@if [ -f test_basic_result.log ]; then echo "åŸºç¡€åŠŸèƒ½æµ‹è¯•: $$(if grep -q "Test case completed" test_basic_result.log; then echo "PASS"; else echo "FAIL"; fi)"; fi
	@if [ -f test_multi_result.log ]; then echo "å¤šå®ä¾‹å¹¶å‘æµ‹è¯•: $$(if grep -q "completed!" test_multi_result.log; then echo "PASS"; else echo "FAIL"; fi)"; fi
	@if [ -f test_transaction_result.log ]; then echo "äº‹åŠ¡æ­£ç¡®æ€§æµ‹è¯•: $$(if grep -q "æ‰€æœ‰æµ‹è¯•é€šè¿‡" test_transaction_result.log; then echo "PASS"; else echo "FAIL"; fi)"; fi
	@echo ""
	@PASSED=0; TOTAL=3; \
	if [ -f test_basic_result.log ] && grep -q "Test case completed" test_basic_result.log; then PASSED=$$((PASSED+1)); fi; \
	if [ -f test_multi_result.log ] && grep -q "completed!" test_multi_result.log; then PASSED=$$((PASSED+1)); fi; \
	if [ -f test_transaction_result.log ] && grep -q "æ‰€æœ‰æµ‹è¯•é€šè¿‡" test_transaction_result.log; then PASSED=$$((PASSED+1)); fi; \
	if [ $$PASSED -eq $$TOTAL ]; then \
		echo "ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼($$PASSED/$$TOTAL)"; \
		echo "å®Œæ•´æµ‹è¯•å¥—ä»¶æ‰§è¡ŒæˆåŠŸï¼"; \
	else \
		echo "âŒ $$((TOTAL-PASSED)) ä¸ªæµ‹è¯•å¤±è´¥ ($$PASSED/$$TOTAL é€šè¿‡)"; \
		echo "è¯·æ£€æŸ¥è¯¦ç»†æ—¥å¿—: test_*_result.log"; \
		exit 1; \
	fi
	@echo ""
	@echo "æ¸…ç†æµ‹è¯•æ–‡ä»¶..."
	@rm -f test_*.log test_full.db .server_pid
	@echo "å®Œæ•´æµ‹è¯•å®Œæˆï¼"

# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
help:
	@echo "Interactive Database - Client-Server Makefile"
	@echo ""
	@echo "Available targets:"
	@echo "  build           - Build both server and client"
	@echo "  server-build    - Build only server"
	@echo "  client-build    - Build only client"
	@echo ""
	@echo "Server targets:"
	@echo "  server          - Run server (port=8080, db=interactive.db)"
	@echo "  server-port     - Run server with custom port: make server-port PORT=8081"
	@echo "  server-db       - Run server with custom database: make server-db DB=mydata.db"
	@echo "  server-custom   - Run server with custom port and database:"
	@echo "                    make server-custom PORT=8081 DB=mydata.db"
	@echo ""
	@echo "Client targets:"
	@echo "  client          - Run client (connects to port 8080)"
	@echo "  client-port     - Run client with custom port: make client-port PORT=8081"
	@echo ""
	@echo "Testing targets:"
	@echo "  test            - Run basic functionality test"
	@echo "  multi-test      - Run multi-instance concurrent test"
	@echo "  transaction-test - Run multi-process transaction correctness test"
	@echo "  test-all        - Run all tests"
	@echo "  demo            - Show demo instructions"
	@echo "  full-test       - Complete automated test"
	@echo "  clean           - Remove compiled files and database"
	@echo "  help            - Show this help message"
	@echo ""
	@echo "Quick start:"
	@echo "  make server     # Terminal 1"
	@echo "  make client     # Terminal 2"
	@echo ""
	@echo "Custom configuration examples:"
	@echo "  make server-port PORT=9000              # Custom port"
	@echo "  make server-db DB=production.db         # Custom database"
	@echo "  make server-custom PORT=9000 DB=test.db # Both custom"
	@echo "  make client-port PORT=9000              # Connect to custom port" 